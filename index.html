<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>X-Wind Pro - Elite</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --safe: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #94a3b8;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: -apple-system, sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        .calculator {
            background: var(--card-bg);
            width: 360px; padding: 20px;
            border-radius: 24px; border: 1px solid #334155;
            position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .settings-btn {
            position: absolute; top: 20px; right: 20px;
            background: none; border: none; font-size: 24px; cursor: pointer; z-index: 10;
        }

        .visualizer-container {
            background: #020617; border-radius: 16px;
            margin-bottom: 15px; display: flex; justify-content: center;
            border: 1px solid #334155; height: 200px; overflow: hidden;
        }

        .input-section {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;
        }

        .field {
            background: #0f172a; padding: 8px; border-radius: 10px;
            text-align: center; border: 2px solid transparent; transition: 0.2s;
        }
        .field.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        .field label { display: block; font-size: 9px; color: var(--accent); font-weight: bold; margin-bottom: 2px; }
        .field input { width: 100%; background: transparent; border: none; color: white; font-size: 18px; text-align: center; outline: none; }

        #display-result {
            background: #020617; height: 60px;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 15px; font-weight: bold;
            border-radius: 10px; margin-bottom: 12px; border: 1px solid #1e293b;
        }
        #display-result.warn-text { color: var(--warning); border-color: var(--warning); }
        #display-result.danger-text { color: var(--danger); border-color: var(--danger); }

        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .keypad button { padding: 14px 0; font-size: 18px; border: none; border-radius: 10px; background: #334155; color: white; }
        .btn-calc { background: var(--accent) !important; grid-row: span 2; color: #0f172a !important; font-weight: bold; }

        /* 設定画面 */
        #settings-modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; border-radius: 24px; z-index: 20; padding: 20px; box-sizing: border-box;
        }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .setting-list { background: #1e293b; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        .setting-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; border-bottom: 1px solid #334155;
        }
        .setting-item:last-child { border-bottom: none; }
        .limit-val { color: var(--accent); font-weight: bold; font-size: 16px; background: #0f172a; padding: 4px 10px; border-radius: 6px; min-width: 30px; text-align: center;}
        
        .active-limit { border: 2px solid var(--accent) !important; }
    </style>
</head>
<body>

    <div class="calculator">
        <button class="settings-btn" onclick="toggleSettings()">⚙️</button>

        <div id="settings-modal">
            <div class="modal-title">Limits & Config</div>
            <div class="setting-list">
                <div class="setting-item" onclick="setLimitTarget('pXwind')">
                    <span>Personal X-Wind Limit</span>
                    <div class="limit-val" id="val-pXwind">15</div>
                </div>
                <div class="setting-item" onclick="setLimitTarget('aXwind')">
                    <span>Aircraft X-Wind Limit</span>
                    <div class="limit-val" id="val-aXwind">25</div>
                </div>
                <div class="setting-item" onclick="setLimitTarget('pTail')">
                    <span>Personal Tail Limit</span>
                    <div class="limit-val" id="val-pTail">5</div>
                </div>
                <div class="setting-item" onclick="setLimitTarget('aTail')">
                    <span>Aircraft Tail Limit</span>
                    <div class="limit-val" id="val-aTail">10</div>
                </div>
            </div>
            
            <div class="keypad" id="settings-keypad">
                <button onclick="appendLimitNum('7')">7</button><button onclick="appendLimitNum('8')">8</button><button onclick="appendLimitNum('9')">9</button><button onclick="clearLimit()">C</button>
                <button onclick="appendLimitNum('4')">4</button><button onclick="appendLimitNum('5')">5</button><button onclick="appendLimitNum('6')">6</button><button onclick="toggleSettings()" style="background:var(--accent); color:#000; font-weight:bold; grid-row:span 3;">SET</button>
                <button onclick="appendLimitNum('1')">1</button><button onclick="appendLimitNum('2')">2</button><button onclick="appendLimitNum('3')">3</button>
                <button onclick="appendLimitNum('0')" style="grid-column: span 3;">0</button>
            </div>
        </div>

        <div class="visualizer-container">
            <canvas id="windCanvas" width="300" height="200"></canvas>
        </div>

        <div class="screen">
            <div class="input-section">
                <div class="field active" id="field-runway" onclick="setActive('runway')">
                    <label>Runway</label><input id="runway" type="text" placeholder="00" readonly>
                </div>
                <div class="field" id="field-windDir" onclick="setActive('windDir')">
                    <label>Wind Dir</label><input id="windDir" type="text" placeholder="000" readonly>
                </div>
                <div class="field" id="field-windSpeed" onclick="setActive('windSpeed')">
                    <label>Wind Speed</label><input id="windSpeed" type="text" placeholder="00" readonly>
                </div>
            </div>
            <div id="display-result">READY</div>
        </div>

        <div class="keypad">
            <button onclick="appendNumber('7')">7</button><button onclick="appendNumber('8')">8</button><button onclick="appendNumber('9')">9</button><button onclick="clearAll()" style="background:#475569; font-size:14px;">CLR</button>
            <button onclick="appendNumber('4')')">4</button><button onclick="appendNumber('5')">5</button><button onclick="appendNumber('6')">6</button><button onclick="deleteLast()" style="background:#475569; font-size:14px;">DEL</button>
            <button onclick="appendNumber('1')">1</button><button onclick="appendNumber('2')">2</button><button onclick="appendNumber('3')">3</button><button onclick="calculate()" class="btn-calc">CALC</button>
            <button onclick="appendNumber('0')" style="grid-column: span 1">0</button><button onclick="appendNumber('.')">.</button><button onclick="switchRunway()" style="background:#6366f1; font-size:11px;">OPP RWY</button>
        </div>
    </div>

    <script>
        let currentActiveField = 'runway';
        let isFirstInput = true;
        let limitTarget = 'pXwind';

        // 限界値の初期値
        const limits = { pXwind: 15, aXwind: 25, pTail: 5, aTail: 10 };

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const isOpening = modal.style.display !== 'block';
            modal.style.display = isOpening ? 'block' : 'none';
            if (!isOpening) calculate(); // 閉じる時に再計算
        }

        function setLimitTarget(target) {
            limitTarget = target;
            document.querySelectorAll('.limit-val').forEach(el => el.classList.remove('active-limit'));
            document.getElementById('val-' + target).classList.add('active-limit');
            isFirstInput = true;
        }

        function appendLimitNum(n) {
            const el = document.getElementById('val-' + limitTarget);
            if (isFirstInput) { el.innerText = n; isFirstInput = false; }
            else { if (el.innerText.length < 3) el.innerText += n; }
            limits[limitTarget] = parseInt(el.innerText);
        }

        function clearLimit() {
            document.getElementById('val-' + limitTarget).innerText = "0";
            limits[limitTarget] = 0;
            isFirstInput = true;
        }

        function setActive(f) {
            currentActiveField = f;
            isFirstInput = true;
            document.querySelectorAll('.field').forEach(el => el.classList.remove('active'));
            document.getElementById('field-' + f).classList.add('active');
        }

        function appendNumber(n) {
            const i = document.getElementById(currentActiveField);
            if (isFirstInput) { i.value = n; isFirstInput = false; }
            else {
                if (currentActiveField === 'runway' && i.value.length >= 2) return;
                if (currentActiveField.startsWith('wind') && i.value.length >= 3) return;
                i.value += n;
            }
            if (currentActiveField === 'runway' && i.value.length === 2) setActive('windDir');
            else if (currentActiveField === 'windDir' && i.value.length === 3) setActive('windSpeed');
        }

        function deleteLast() {
            const i = document.getElementById(currentActiveField);
            i.value = i.value.slice(0, -1);
        }

        function clearAll() {
            document.querySelectorAll('.screen input').forEach(i => i.value = "");
            setActive('runway');
            document.getElementById('display-result').className = "";
            document.getElementById('display-result').innerText = "READY";
            calculate();
        }

        function switchRunway() {
            const r = document.getElementById('runway');
            let v = parseInt(r.value);
            if (!isNaN(v)) {
                r.value = (v <= 18 ? v + 18 : v - 18).toString().padStart(2, '0');
                calculate();
            }
        }

        function calculate() {
            const rVal = parseFloat(document.getElementById('runway').value);
            const d = parseFloat(document.getElementById('windDir').value);
            const s = parseFloat(document.getElementById('windSpeed').value);
            if (isNaN(rVal) || isNaN(d) || isNaN(s)) return;

            const rDeg = rVal * 10;
            const rad = (d - rDeg) * (Math.PI / 180);
            const xw = Math.abs(s * Math.sin(rad));
            const hw = s * Math.cos(rad);

            const res = document.getElementById('display-result');
            res.className = "";
            
            // ロジック：航空機限界(赤) > 自己限界(黄)
            if (xw > limits.aXwind || (hw < -limits.aTail)) {
                res.classList.add('danger-text');
            } else if (xw > limits.pXwind || (hw < -limits.pTail)) {
                res.classList.add('warn-text');
            }

            res.innerHTML = `X-WIND: ${xw.toFixed(1)} KT<br>${hw >= 0 ? 'HEAD' : 'TAIL'}: ${Math.abs(hw).toFixed(1)} KT`;
            drawVisuals(rDeg, d);
        }

        function drawVisuals(rDeg, wDir) {
            const canvas = document.getElementById('windCanvas');
            const ctx = canvas.getContext('2d');
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(cx, cy);

            // 1. コンパスローズ（背景目盛り）
            ctx.strokeStyle = "#1e293b";
            ctx.lineWidth = 1;
            for(let i=0; i<360; i+=10) {
                ctx.save();
                ctx.rotate(i * Math.PI / 180);
                ctx.beginPath();
                ctx.moveTo(0, -85);
                ctx.lineTo(0, i % 90 === 0 ? -70 : -80);
                ctx.stroke();
                ctx.restore();
            }

            // 2. 滑走路（縦固定）
            drawRunway(ctx, document.getElementById('runway').value);

            // 3. 風の矢印（相対角度）
            const windRel = (wDir - rDeg - 90) * Math.PI / 180;
            drawWind(ctx, windRel);

            // 4. 北方位ポインター
            ctx.save();
            ctx.rotate(-rDeg * Math.PI / 180);
            ctx.fillStyle = "#475569";
            ctx.font = "bold 14px Arial";
            ctx.fillText("N", -5, -90);
            ctx.restore();

            ctx.restore();
        }

        function drawRunway(ctx, num) {
            ctx.fillStyle = "#334155";
            ctx.fillRect(-15, -60, 30, 120);
            ctx.strokeStyle = "rgba(255,255,255,0.5)";
            ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0, -50); ctx.lineTo(0, 50); ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = "white"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
            ctx.fillText(num, 0, 55);
            
            // 反対側
            let opp = (parseInt(num) <= 18 ? parseInt(num) + 18 : parseInt(num) - 18);
            ctx.save(); ctx.translate(0, -45); ctx.rotate(Math.PI);
            ctx.fillText(opp.toString().padStart(2, '0'), 0, 0); ctx.restore();
        }

        function drawWind(ctx, rad) {
            ctx.save();
            ctx.rotate(rad);
            ctx.strokeStyle = varProp('--accent'); ctx.fillStyle = varProp('--accent'); ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(90, 0); ctx.lineTo(40, 0); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(40, 0); ctx.lineTo(53, -7); ctx.lineTo(53, 7); ctx.fill();
            // 矢羽根
            ctx.beginPath(); ctx.moveTo(90,0); ctx.lineTo(100,-10); ctx.moveTo(90,0); ctx.lineTo(100,10);
            ctx.moveTo(80,0); ctx.lineTo(90,-10); ctx.moveTo(80,0); ctx.lineTo(90,10); ctx.stroke();
            ctx.restore();
        }

        function varProp(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }
    </script>
</body>
</html>
