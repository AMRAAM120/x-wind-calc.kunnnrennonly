<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>X-Wind Pro - Ultra Stable</title>
    <style>
        :root {
            --bg-color: #0f121a;
            --card-bg: #252b41;
            --accent: #00e5ff;
            --safe: #00f2ad;
            --warning: #ffb300;
            --danger: #ff5252;
            --gray: #6b7280;
            --dark-blue: #0f172a;
        }

        /* スマホでの中央配置を強制 */
        body {
            background-color: var(--bg-color);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
        }

        .calculator {
            background: var(--card-bg);
            /* 幅のレスポンシブ対応を強化 */
            width: 92%;
            max-width: 360px;
            padding: 18px;
            border-radius: 28px;
            border: 2px solid #3d445a;
            position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            box-sizing: border-box;
            /* 左右中央寄せ */
            margin: auto;
        }

        .settings-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: var(--gray);
            font-size: 18px; cursor: pointer; z-index: 10; opacity: 0.5;
        }

        .visualizer-container {
            background: var(--dark-blue); border-radius: 16px;
            margin-bottom: 12px; display: flex; justify-content: center;
            border: 1.5px solid #334155; height: 175px; overflow: hidden; position: relative;
        }

        .input-section {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;
        }

        .field {
            background: var(--dark-blue); padding: 8px 4px; border-radius: 10px;
            text-align: center; border: 2px solid transparent; transition: 0.2s;
        }
        .field.active { border-color: var(--accent); }
        .field label { display: block; font-size: 8px; color: var(--accent); font-weight: 800; margin-bottom: 3px; text-transform: uppercase; }
        .field input { width: 100%; background: transparent; border: none; color: white; font-size: 20px; text-align: center; outline: none; font-weight: 900; }

        #display-result {
            background: var(--dark-blue); height: 50px;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 14px; font-weight: 900;
            border-radius: 10px; margin-bottom: 10px; border: 1px solid #1e293b;
        }
        .warn-text { color: var(--warning); border: 2px solid var(--warning); }
        .danger-text { color: var(--danger); border: 2px solid var(--danger); }

        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 7px; }
        .keypad button { padding: 14px 0; font-size: 22px; border: none; border-radius: 10px; background: #333a4f; color: white; font-weight: 900; cursor: pointer; }
        .keypad button:active { background: #454f6b; transform: scale(0.96); }
        
        /* CALCボタン文字調整 */
        .btn-calc { background: var(--accent) !important; grid-row: span 2; color: #000 !important; font-size: 15px !important; letter-spacing: 0px; }

        #settings-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #151926; border-radius: 26px; z-index: 20; padding: 18px; box-sizing: border-box;
        }
        .modal-header { display: flex; align-items: center; margin-bottom: 15px; }
        .icon-back { width: 26px; height: 26px; cursor: pointer; color: var(--accent); }
        .modal-title { font-size: 16px; font-weight: 900; flex-grow: 1; text-align: center; margin-right: 26px; }
        
        .menu-list { background: #1e2436; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 1px solid #334155; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; border-bottom: 1px solid #2a3147; font-size: 14px; }
        .icon-arrow-r { width: 18px; height: 18px; background: #333a4f; border-radius: 5px; padding: 3px; color: var(--gray); }

        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .3s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--safe); }
        input:checked + .slider:before { transform: translateX(22px); }

        .limit-active { border: 2px solid var(--accent) !important; background: var(--dark-blue) !important; border-radius: 7px; }
        .val-warn { color: var(--warning) !important; font-weight: 900; }
        .val-danger { color: var(--danger) !important; font-weight: 900; }
    </style>
</head>
<body onload="loadSettings()">

    <div class="calculator">
        <button class="settings-btn" onclick="openMenu()">⚙️</button>

        <div id="settings-overlay">
            <div id="page-main">
                <div class="modal-header"><div class="modal-title">Settings</div></div>
                <div class="menu-list">
                    <div class="menu-item">
                        <span style="font-weight: bold;">North Up Mode</span>
                        <label class="switch"><input type="checkbox" id="mode-toggle" onchange="calculate()"><span class="slider"></span></label>
                    </div>
                    <div class="menu-item" onclick="showPage('limit')">
                        <span style="font-weight: bold;">Limits & Config</span>
                        <svg class="icon-arrow-r" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
                <button onclick="closeSettings()" style="width: 100%; padding: 14px; border-radius: 10px; background: var(--accent); color: #000; font-weight: 900; border: none; font-size: 15px; cursor: pointer;">CLOSE</button>
            </div>

            <div id="page-limit" style="display: none;">
                <div class="modal-header">
                    <svg class="icon-back" onclick="showPage('main')" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    <div class="modal-title">Limits Config</div>
                </div>
                <div class="menu-list" style="margin-bottom: 10px;">
                    <div class="menu-item" onclick="setLimitTarget('pXwind')"><span>Personal X-Wind</span><div class="limit-val val-warn" id="val-pXwind" style="padding: 3px 8px;">15</div></div>
                    <div class="menu-item" onclick="setLimitTarget('aXwind')"><span>Aircraft X-Wind</span><div class="limit-val val-danger" id="val-aXwind" style="padding: 3px 8px;">25</div></div>
                    <div class="menu-item" onclick="setLimitTarget('pTail')"><span>Personal Tail</span><div class="limit-val val-warn" id="val-pTail" style="padding: 3px 8px;">5</div></div>
                    <div class="menu-item" onclick="setLimitTarget('aTail')"><span>Aircraft Tail</span><div class="limit-val val-danger" id="val-aTail" style="padding: 3px 8px;">10</div></div>
                </div>
                <div class="keypad">
                    <button onclick="appendLimitNum('7')">7</button><button onclick="appendLimitNum('8')">8</button><button onclick="appendLimitNum('9')">9</button><button onclick="clearLimit()" style="color:var(--danger); font-size: 16px;">C</button>
                    <button onclick="appendLimitNum('4')">4</button><button onclick="appendLimitNum('5')">5</button><button onclick="appendLimitNum('6')">6</button><button onclick="saveAndGoBack()" style="background:var(--safe) !important; grid-row:span 3; font-size: 16px; color:#000 !important;">OK</button>
                    <button onclick="appendLimitNum('1')">1</button><button onclick="appendLimitNum('2')">2</button><button onclick="appendLimitNum('3')">3</button>
                    <button onclick="appendLimitNum('0')" style="grid-column: span 3;">0</button>
                </div>
            </div>
        </div>

        <div class="visualizer-container"><canvas id="windCanvas" width="300" height="175"></canvas></div>

        <div class="screen">
            <div class="input-section">
                <div class="field active" id="field-runway" onclick="setActive('runway')"><label>Runway</label><input id="runway" type="text" placeholder="00" readonly></div>
                <div class="field" id="field-windDir" onclick="setActive('windDir')"><label>Wind Dir</label><input id="windDir" type="text" placeholder="000" readonly></div>
                <div class="field" id="field-windSpeed" onclick="setActive('windSpeed')"><label>Wind Speed</label><input id="windSpeed" type="text" placeholder="00" readonly></div>
            </div>
            <div id="display-result">READY</div>
        </div>

        <div class="keypad">
            <button onclick="appendNumber('7')">7</button><button onclick="appendNumber('8')">8</button><button onclick="appendNumber('9')">9</button><button onclick="clearAll()" style="font-size:12px; background:#475569;">CLR</button>
            <button onclick="appendNumber('4')">4</button><button onclick="appendNumber('5')">5</button><button onclick="appendNumber('6')">6</button><button onclick="deleteLast()" style="font-size:12px; background:#475569;">DEL</button>
            <button onclick="appendNumber('1')">1</button><button onclick="appendNumber('2')">2</button><button onclick="appendNumber('3')">3</button><button onclick="calculate()" class="btn-calc">CALC</button>
            <button onclick="appendNumber('0')">0</button><button onclick="appendNumber('.')">.</button><button onclick="switchRunway()" style="background:#6366f1; font-size:9px; line-height: 1.1;">OPP<br>RWY</button>
        </div>
    </div>

    <script>
        let currentActiveField = 'runway', isFirstInput = true, limitTarget = 'pXwind';
        let limits = { pXwind: 15, aXwind: 25, pTail: 5, aTail: 10 };

        function loadSettings() {
            const saved = localStorage.getItem('xwind_limits');
            if (saved) { limits = JSON.parse(saved); document.getElementById('val-pXwind').innerText = limits.pXwind; document.getElementById('val-aXwind').innerText = limits.aXwind; document.getElementById('val-pTail').innerText = limits.pTail; document.getElementById('val-aTail').innerText = limits.aTail; }
            calculate();
        }

        function saveAndGoBack() { localStorage.setItem('xwind_limits', JSON.stringify(limits)); showPage('main'); }
        function openMenu() { document.getElementById('settings-overlay').style.display = 'block'; showPage('main'); }
        function closeSettings() { document.getElementById('settings-overlay').style.display = 'none'; calculate(); }
        function showPage(p) { document.getElementById('page-main').style.display = p==='main'?'block':'none'; document.getElementById('page-limit').style.display = p==='limit'?'block':'none'; if(p==='limit')setLimitTarget('pXwind');}
        function setLimitTarget(t) { limitTarget = t; isFirstInput = true; document.querySelectorAll('.limit-val').forEach(el=>el.classList.remove('limit-active')); document.getElementById('val-'+t).classList.add('limit-active'); }
        function appendLimitNum(n) { const el = document.getElementById('val-'+limitTarget); if(isFirstInput){el.innerText=n; isFirstInput=false;} else if(el.innerText.length<3)el.innerText+=n; limits[limitTarget]=parseInt(el.innerText); }
        function clearLimit() { document.getElementById('val-'+limitTarget).innerText="0"; limits[limitTarget]=0; isFirstInput=true; }
        function setActive(f) { currentActiveField = f; isFirstInput = true; document.querySelectorAll('.field').forEach(el=>el.classList.remove('active')); document.getElementById('field-'+f).classList.add('active'); }
        
        function appendNumber(n) { 
            const i = document.getElementById(currentActiveField); 
            if(isFirstInput){i.value=n; isFirstInput=false;} 
            else { 
                if(currentActiveField==='runway'&&i.value.length>=2)return; 
                if(i.value.length>=3)return; 
                i.value+=n; 
            } 
            calculate();
            if(currentActiveField==='runway'&&i.value.length===2) setActive('windDir'); 
            else if(currentActiveField==='windDir'&&i.value.length===3) setActive('windSpeed');
        }

        function deleteLast() { const i=document.getElementById(currentActiveField); i.value=i.value.slice(0,-1); calculate(); }
        function clearAll() { document.querySelectorAll('.screen input').forEach(i=>i.value=""); setActive('runway'); calculate(); }
        function switchRunway() { const r=document.getElementById('runway'); if(r.value){r.value=(parseInt(r.value)<=18?parseInt(r.value)+18:parseInt(r.value)-18).toString().padStart(2,'0'); calculate();} }

        function calculate() {
            const rIn = document.getElementById('runway').value;
            const rVal = parseFloat(rIn), d = parseFloat(document.getElementById('windDir').value), s = parseFloat(document.getElementById('windSpeed').value);
            const rDeg = !isNaN(rVal) ? rVal * 10 : 0;
            const res = document.getElementById('display-result');
            
            if(isNaN(rVal)||isNaN(d)||isNaN(s)) {
                res.className = ""; res.innerText = "READY";
                draw(rDeg, isNaN(d) ? 0 : d, 0); // 速度0として描画
                return;
            }

            const rad = (d-rDeg)*(Math.PI/180), xw = Math.abs(s*Math.sin(rad)), hw = s*Math.cos(rad);
            res.className = "";
            if(xw > limits.aXwind || (hw < -limits.aTail)) res.classList.add('danger-text');
            else if(xw > limits.pXwind || (hw < -limits.pTail)) res.classList.add('warn-text');
            res.innerHTML = `X-WIND: ${xw.toFixed(1)} KT<br>${hw>=0?'HEAD':'TAIL'}: ${Math.abs(hw).toFixed(1)} KT`;
            
            draw(rDeg, d, s);
        }

        function draw(rDeg, wDir, s) {
            const c=document.getElementById('windCanvas'), ctx=c.getContext('2d'), cx=c.width/2, cy=c.height/2;
            const rText = document.getElementById('runway').value || "00";
            ctx.clearRect(0,0,c.width,c.height);
            ctx.save(); ctx.translate(cx,cy);
            
            // 方位目盛り
            ctx.strokeStyle = "#2a3147"; ctx.lineWidth = 1.5;
            for(let i=0; i<360; i+=10) {
                ctx.save(); ctx.rotate(i*Math.PI/180);
                ctx.beginPath(); ctx.moveTo(0,-78); ctx.lineTo(0, i%90===0?-65:-73); ctx.stroke(); ctx.restore();
            }

            if(document.getElementById('mode-toggle').checked) { // North Up
                ctx.save(); ctx.rotate((rDeg-90)*Math.PI/180); drawR(ctx, rText); ctx.restore();
                if(s > 0) drawSimpleArrow(ctx, (wDir-90)*Math.PI/180);
                drawN(ctx, 0);
            } else { // Heading Up
                drawR(ctx, rText);
                if(s > 0) drawSimpleArrow(ctx, (wDir-rDeg-90)*Math.PI/180);
                drawN(ctx, -rDeg);
            }
            ctx.restore();
        }

        function drawR(ctx, num) {
            ctx.fillStyle = "#3d445a"; ctx.fillRect(-12, -55, 24, 110);
            ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 0.8; ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0, -45); ctx.lineTo(0, 45); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillStyle = "white";
            for(let i=-8; i<=8; i+=4) { ctx.fillRect(i, 48, 2, 7); ctx.fillRect(i, -55, 2, 7); }
            ctx.font = "bold 13px Arial"; ctx.textAlign = "center";
            ctx.fillText(num, 0, 44);
            let n = parseInt(num) || 0;
            let opp = (n<=18?n+18:n-18).toString().padStart(2,'0');
            ctx.save(); ctx.translate(0,-38); ctx.rotate(Math.PI); ctx.fillText(opp, 0, 0); ctx.restore();
        }

        function drawSimpleArrow(ctx, rad) {
            const headlen = 10, startDist = 85, endDist = 35;
            ctx.save(); ctx.rotate(rad);
            ctx.strokeStyle = "#00e5ff"; ctx.fillStyle = "#00e5ff"; ctx.lineWidth = 3.5;
            ctx.beginPath(); ctx.moveTo(startDist, 0); ctx.lineTo(endDist, 0); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(endDist, 0);
            ctx.lineTo(endDist + headlen, -headlen/1.8);
            ctx.lineTo(endDist + headlen, headlen/1.8);
            ctx.closePath(); ctx.fill(); ctx.restore();
        }

        function drawN(ctx, deg) {
            ctx.save(); ctx.rotate(deg*Math.PI/180); ctx.fillStyle="#6b7280"; ctx.font="bold 13px Arial"; ctx.fillText("N", 0, -84); ctx.restore();
        }
    </script>
</body>
</html>
